<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description"
    content="Book your luxurious stay at Grand Lynks Homes & Apartments in Gwarinpa, Abuja. Check availability and reserve your room." />
  <meta name="keywords"
    content="Grand Lynks, Booking, Reserve, Hotel, Apartments, Abuja, Gwarinpa, luxury, accommodation" />
  <title>Grand Lynks Homes & Apartments – Booking</title>
  <link rel="icon" href="images/grandfullfront.jpeg" type="image/jpeg" />
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="booking.css" />
  <link rel="stylesheet" href="preloader.css" />
  <!-- Link booking.css -->
  <!-- Paystack -->
  <script src="config.js"></script>
  <script src="https://js.paystack.co/v1/inline.js"></script>
  <script src="preloader.js"></script>
  <script src="booking-integration.js"></script>
</head>

<body class="booking-page">
  <!-- HEADER -->
  <header>
    <div id="navbar-placeholder"></div>
  </header>

  <main class="booking-content-wrapper">
    <div class="wrap">
      <div class="columns">
        <!-- Left stack: Availability → Room selection → Guest details -->
        <div class="col-left">
          <!-- Booking Summary (hidden initially) -->
          <section class="panel hidden" id="bookingSummaryPanel">
            <h3>Booking Summary</h3>
            <div id="bookingSummary"></div>
          </section>
          <!-- Step 1: Availability -->
          <section class="panel" id="availabilityPanel" aria-labelledby="availabilityTitle">
            <h2 id="availabilityTitle">Book Your Stay</h2>
            <div class="stack">
              <label for="checkin">Check-in</label>
              <input type="date" id="checkin" required />

              <label for="checkout">Check-out</label>
              <input type="date" id="checkout" required />

              <label for="guests">Guests</label>
              <select id="guests" required>
                <option value="">Select guests</option>
                <option>1</option>
                <option>2</option>

              </select>

              <button id="btnCheck">Check Availability</button>
              <div id="availabilityNote" class="muted"></div>
            </div>
          </section>

          <!-- Step 2: Rooms list (from API) -->
          <section class="panel hidden" id="roomsPanel" aria-labelledby="roomsTitle">
            <h3 id="roomsTitle">Available Rooms</h3>
            <div id="roomsList" class="stack" role="list"></div>
            <div id="altNote" class="muted"></div>
          </section>

          <!-- Step 3: Guest details + T&C + Paystack -->
          <section class="panel hidden" id="detailsPanel" aria-labelledby="detailsTitle">
            <h3 id="detailsTitle">Your Details</h3>
            <div class="stack">
              <label for="fullName">Full Name</label>
              <input id="fullName" type="text" required />

              <label for="email">Email</label>
              <input id="email" type="email" required />

              <label for="phone">Phone</label>
              <input id="phone" type="tel" placeholder="+234..." required />

              <label style="display: flex; gap: 8px; align-items: center">
                <input id="acceptTerms" type="checkbox" />
                <span>I agree to the
                  <a href="#" id="openTerms">Terms & Conditions</a></span>
              </label>

              <button id="btnPay" disabled>Pay with Paystack</button>
            </div>
          </section>
        </div>

        <!-- Right: Summary -->
        <aside class="summary" aria-live="polite">
          <h3>Booking Summary</h3>
          <div class="row"><span>Room:</span><span id="sumRoom">—</span></div>
          <div class="row">
            <span>Price (per night):</span><span id="sumPrice">—</span>
          </div>
          <div class="row">
            <span>Nights:</span><span id="sumNights">—</span>
          </div>
          <div class="row total">
            <span>Total:</span><span id="sumTotal">—</span>
          </div>
        </aside>
      </div>
    </div>

    <!-- Terms & Conditions Modal -->
    <div id="termsModalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="termsTitle">
      <div class="modal">
        <header>
          <h2 id="termsTitle">Terms & Conditions</h2>
        </header>
        <div class="content">
          <p>
            <strong>1. Check-in / Check-out</strong><br />
            Check-in is from 1:00 PM; check-out by 12:00 PM. Early/late options
            are subject to availability and may incur charges.
          </p>
          <p>
            <strong>2. Booking & Payment</strong><br />
            A booking is confirmed only after full payment is
            received. Prices are in NGN and may vary by date and availability.
          </p>
          <p>
            <strong>3. Cancellation & No-Show</strong><br />
            Cancellations within 24 hours of check-in are non-refundable.
            No-shows forfeit payments made.
          </p>
          <p>
            <strong>4. Identification</strong><br />
            Valid government ID are required at check-in.
          </p>
          <p>
            <strong>5. Security & Damages</strong><br />
            Guests are responsible for damages or losses to property during
            their stay. A security deposit may be required.
          </p>
          <p>
            <strong>6. Smoking & Conduct</strong><br />
            Smoking is prohibited in rooms. Excessive noise or misconduct may
            result in eviction without refund.
          </p>
          <p>
            <strong>7. Liability</strong><br />
            The property is not liable for loss of money, jewelry, or valuables
            not deposited with management.
          </p>
          <p>
            <strong>8. Force Majeure</strong><br />
            The property is not responsible for events beyond reasonable control
            (e.g., power outages, strikes, acts of God).
          </p>
          <p>
            <strong>9. Privacy</strong><br />
            Booking details are used to manage your stay and comply with legal
            requirements.
          </p>
          <p>
            <strong>10. Special Requests</strong><br />
            Subject to availability and not guaranteed.
          </p>
        </div>
        <footer>
          <button class="btn btn-secondary" id="closeTerms">Close</button>
          <button class="btn btn-primary" id="acceptAndClose">
            Accept & Close
          </button>
        </footer>
      </div>
    </div>
    </div>
  </main>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      fetch("components/navbar.html?v=" + new Date().getTime())
        .then((response) => response.text())
        .then((data) => {
          document.getElementById("navbar-placeholder").innerHTML = data;

          // Initialize mobile menu functionality
          const mobileToggle = document.querySelector(".mobile-menu-toggle");
          const navLinks = document.querySelector(".nav-links");

          if (mobileToggle && navLinks) {
            mobileToggle.addEventListener("click", function () {
              navLinks.classList.toggle("active");
              mobileToggle.classList.toggle("open");
            });

            // Close mobile menu when clicking on a link
            navLinks.querySelectorAll("a").forEach((link) => {
              link.addEventListener("click", () => {
                navLinks.classList.remove("active");
                mobileToggle.classList.remove("open");
              });
            });
          }
        });

      // ------- Config -------
      const API_BASE = window.APP_CONFIG.API_URL;
      const PAYSTACK_PUBLIC_KEY = window.APP_CONFIG?.PAYSTACK_PUBLIC_KEY || "pk_test_51b8b8b8b8b8b8b8b8b8b8b8b8b8b8b8b8b8b8b8b8";

      // ------- State -------
      let rooms = []; // from API
      let selectedRoom = null; // { id, type, price, available }

      let nights = 0;

      // ------- Helpers -------
      const el = (id) => document.getElementById(id);
      const money = (n) => "₦" + (n || 0).toLocaleString();

      function calcNights() {
        const inVal = el("checkin").value;
        const outVal = el("checkout").value;
        if (!inVal || !outVal) return 0;
        const inDate = new Date(inVal);
        const outDate = new Date(outVal);
        const ms = outDate - inDate;
        if (ms <= 0) return 0;
        return Math.ceil(ms / (1000 * 60 * 60 * 24));
      }

      function updateSummary() {
        const roomPrice = selectedRoom ? (selectedRoom.pricePerNight || selectedRoom.price) : 0;
        el("sumRoom").textContent = selectedRoom ? selectedRoom.type : "—";
        el("sumPrice").textContent = selectedRoom
          ? money(roomPrice)
          : "—";
        el("sumNights").textContent = nights || "—";
        const total = selectedRoom && nights ? roomPrice * nights : 0;
        el("sumTotal").textContent = total ? money(total) : "—";
        return total;
      }

      function renderRoomsList(list) {
        const container = el("roomsList");
        container.innerHTML = "";
        list.forEach((room) => {
          const roomPrice = room.pricePerNight || room.price;
          const div = document.createElement("div");
          div.className = "room-option";
          div.setAttribute("role", "listitem");
          div.textContent = `${room.type} – ${money(roomPrice)}/night`;

          div.onclick = () => {
            selectedRoom = room;
            el("detailsPanel").classList.remove("hidden");
            updateSummary();
            // enable pay only when T&C checked & fields completed
            gatePayButton();
            window.scrollTo({
              top: document.body.scrollHeight,
              behavior: "smooth",
            });
          };
          container.appendChild(div);
        });
      }

      function gatePayButton() {
        const ok =
          selectedRoom &&
          nights > 0 &&
          el("fullName").value.trim() &&
          el("email").value.trim() &&
          el("phone").value.trim() &&
          el("acceptTerms").checked;
        el("btnPay").disabled = !ok;
      }

      // ------- Flow -------
      // 1) Load rooms once
      async function loadRooms() {
        const res = await fetch(`${API_BASE}/rooms`);
        rooms = await res.json(); // expects [{id,type,price,available},...]
      }

      // 2) Check availability
      async function onCheckAvailability() {
        nights = calcNights();
        if (!nights) {
          el("availabilityNote").textContent =
            "Please choose a valid date range.";
          return;
        }
        el("availabilityNote").textContent = `Stay length: ${nights} night${nights > 1 ? "s" : ""
          }.`;

        const checkButton = el("btnCheck");
        const roomsPanel = el("roomsPanel");

        // --- Show loading state ---
        if (window.Preloader) {
          window.Preloader.showButtonLoading(checkButton);
        }
        roomsPanel.classList.remove("hidden");
        el("roomsList").innerHTML = '<div class="loader-dots-small"></div>'; // Show inline loader

        try {
          // Always fetch from backend
          const res = await fetch(`${API_BASE}/check-availability`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              checkIn: el("checkin").value,
              checkOut: el("checkout").value
            })
          });

          if (!res.ok) throw new Error("Network response was not ok");

          const available = await res.json();

          // ✅ This part shows rooms OR "no rooms available"
          if (Array.isArray(available)) {
            renderRoomsList(available);
            console.log("Available rooms:", available);

            el("altNote").textContent = available.length
              ? ""
              : "Selected dates have no available rooms at the moment. Please try different dates or contact us.";
          } else {
            throw new Error("Unexpected response format");
          }

        } catch (error) {
          console.error("Error checking availability:", error);
          el("altNote").textContent = "Error checking availability. Please try again.";
        } finally {
          if (window.Preloader) {
            window.Preloader.hideButtonLoading(checkButton);
          }
        }
      }

      // 3) Terms modal
      const modal = el("termsModalBackdrop");
      function openTerms() {
        modal.classList.add("open");
        document.body.style.overflow = "hidden";
      }
      function closeTerms() {
        modal.classList.remove("open");
        document.body.style.overflow = "";
      }

      // 4) Paystack
      function payWithPaystack() {
        const total = updateSummary();
        if (!total) {
          alert("Please select a room and valid dates.");
          return;
        }

        // Show loading state
        if (window.Preloader) {
          window.Preloader.showButtonLoading(el("btnPay"));
        }

        const handler = PaystackPop.setup({
          key: PAYSTACK_PUBLIC_KEY,
          email: el("email").value.trim(),
          amount: total * 100, // kobo
          currency: "NGN",
          ref: "GL-" + Date.now(),
          metadata: {
            custom_fields: [
              {
                display_name: "Name",
                variable_name: "name",
                value: el("fullName").value.trim(),
              },
              {
                display_name: "Phone",
                variable_name: "phone",
                value: el("phone").value.trim(),
              },
              {
                display_name: "Room",
                variable_name: "room",
                value: selectedRoom.type,
              },
              {
                display_name: "Nights",
                variable_name: "nights",
                value: String(nights),
              },
              {
                display_name: "Check-in",
                variable_name: "checkin",
                value: el("checkin").value,
              },
              {
                display_name: "Check-out",
                variable_name: "checkout",
                value: el("checkout").value,
              },
            ],
          },
          callback: function (response) {
            // Hide loading state
            if (window.Preloader) {
              window.Preloader.hideButtonLoading(el("btnPay"));
            }

            alert("Payment successful! Ref: " + response.reference);

            // First create/find guest, then create booking
            const guestData = {
              name: el("fullName").value.trim(),
              email: el("email").value.trim(),
              phone: el("phone").value.trim(),
            };

            // Create guest first, then booking
            fetch(`${API_BASE}/guests`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(guestData),
            })
              .then(res => res.json())
              .then(guestResponse => {
                const guestId = guestResponse.guest ? guestResponse.guest.id : guestResponse.id;

                // Now create the booking
                return fetch(`${API_BASE}/bookings`, {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    guestId: guestId,
                    roomId: selectedRoom.id,
                    startDate: el("checkin").value,
                    endDate: el("checkout").value,
                    status: 'confirmed'
                  }),
                });
              })
              .then(res => res.json())
              .then(bookingResponse => {
                // Create payment record
                return fetch(`${API_BASE}/payments`, {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    amount: total,
                    method: 'card',
                    reference: response.reference,
                    status: 'completed',
                    guestId: bookingResponse.booking ? bookingResponse.booking.guestId : bookingResponse.guestId,
                    bookingId: bookingResponse.booking ? bookingResponse.booking.id : bookingResponse.id
                  }),
                });
              })
              .catch(error => {
                console.error('Error creating booking/payment:', error);
              });
            window.location.href = "thankyou.html";
          },
          onClose: function () {
            // Hide loading state
            if (window.Preloader) {
              window.Preloader.hideButtonLoading(el("btnPay"));
            }
            alert("Payment window closed.");
          },
        });
        handler.openIframe();
      }

      // ------- Events -------
      el("btnCheck").addEventListener("click", onCheckAvailability);

      ["checkin", "checkout"].forEach((id) => {
        el(id).addEventListener("change", () => {
          nights = calcNights();
          updateSummary();
          gatePayButton();
        });
      });

      ["fullName", "email", "phone"].forEach((id) => {
        el(id).addEventListener("input", gatePayButton);
      });

      el("acceptTerms").addEventListener("change", gatePayButton);
      el("openTerms").addEventListener("click", (e) => {
        e.preventDefault();
        openTerms();
      });
      el("closeTerms").addEventListener("click", closeTerms);
      el("acceptAndClose").addEventListener("click", () => {
        el("acceptTerms").checked = true;
        gatePayButton();
        closeTerms();
      });

      el("btnPay").addEventListener("click", payWithPaystack);
    });
  </script>
  <script src="mobile-enhancements.js"></script>
</body>

</html>